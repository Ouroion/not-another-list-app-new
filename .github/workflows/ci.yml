name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]


jobs:
  # Build job - runs first
  build-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Install docker-compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose
          docker-compose version

      - name: Build containers
        run: docker-compose build

      - name: List built images
        run: docker images

      - name: Trivy - natl_backend_api
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'not-another-list-app-new_natl_backend_api'
          format: 'table'
          severity: 'CRITICAL,HIGH'

      - name: Trivy - frontend
        uses: aquasecurity/trivy-action@master
        with:
         scan-type: 'image'
         image-ref: 'not-another-list-app-new_frontend'
         format: 'table'
         severity: 'CRITICAL,HIGH'

      - name: Trivy - db
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'not-another-list-app-new_db'
          format: 'table'
          severity: 'CRITICAL,HIGH'

      - name: Trivy - test
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'not-another-list-app-new_test'
          format: 'table'
          severity: 'CRITICAL,HIGH'

  # Static analysis job - runs after build
  flake8:
    runs-on: ubuntu-latest
    needs: build-job

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Display Python version
        run: |
          python --version
          pip --version

      - name: Install flake8
        run: pip install -U flake8

      - name: Run flake8 linter
        run: flake8 --max-line-length=120 backend/src

  # Test job - runs after static analysis
  unit-test-job:
    runs-on: ubuntu-latest
    needs: flake8

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Install docker-compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose
          docker-compose version

      - name: Build containers in parallel
        run: docker-compose build --parallel

      - name: Start backend and database services
        run: docker-compose up -d natl_backend_api db

      - name: Run tests
        run: docker-compose run --rm test

      - name: Stop services
        if: always()
        run: docker-compose down
  healthcheck:
    runs-on: ubuntu-latest
    needs: build-job
    steps:
      - uses: actions/checkout@v3

      - name: Install docker-compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose
          docker-compose version

      - name: Start Docker Compose services
        run: docker-compose up -d

      - name: Check service health
        uses: jaracogmbh/docker-compose-health-check-action@v1.0.0
        with:
          max-retries: 30
          retry-interval: 10
          compose-file: "docker-compose.yml"
          skip-exited: "true"
          skip-no-healthcheck: "true"

  # Deploy stage placeholder
  # deploy-job:
  #   runs-on: ubuntu-latest
  #   needs: unit-test-job
  #